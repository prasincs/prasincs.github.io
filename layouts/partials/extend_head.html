{{- /* Head custom content area start */ -}}
{{- /*     Insert any custom code (web-analytics, resources, etc.) - it will appear in the <head></head> section of every page. */ -}}
{{- /*     Can be overwritten by partial with the same name in the global layouts. */ -}}
{{- /* Head custom content area end */ -}}

<!-- Highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
<script>hljs.highlightAll();</script>

<!-- Mermaid diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({ startOnLoad: false, theme: 'dark' });
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('code.language-mermaid').forEach(function(el) {
      const pre = el.parentElement;
      const div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = el.textContent;
      pre.parentNode.replaceChild(div, pre);
    });
    mermaid.run();
  });
</script>

<!-- Scrollspy for TOC -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Force TOC open on large screens
  if (window.innerWidth >= 1280) {
    const tocDetails = document.querySelector('.toc-sidebar .toc details');
    if (tocDetails) {
      tocDetails.setAttribute('open', '');
    }
  }

  const tocLinks = document.querySelectorAll('.toc a');
  const headings = [];

  // Get all headings that TOC links to
  tocLinks.forEach(link => {
    const id = link.getAttribute('href')?.slice(1);
    if (id) {
      const heading = document.getElementById(id);
      if (heading) {
        headings.push({ id, element: heading, link });
      }
    }
  });

  if (headings.length === 0) return;

  function updateActiveLink() {
    const scrollPos = window.scrollY + 120; // offset for header

    let current = headings[0];

    for (const heading of headings) {
      if (heading.element.offsetTop <= scrollPos) {
        current = heading;
      } else {
        break;
      }
    }

    tocLinks.forEach(link => link.classList.remove('active'));
    if (current) {
      current.link.classList.add('active');

      // Scroll TOC to show active item
      const toc = document.querySelector('.toc .inner');
      if (toc) {
        const linkTop = current.link.offsetTop;
        const tocHeight = toc.clientHeight;
        if (linkTop > tocHeight / 2) {
          toc.scrollTop = linkTop - tocHeight / 2;
        }
      }
    }
  }

  // Throttle scroll events
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial call
  updateActiveLink();
});
</script>

{{- /* Load music notation libraries for posts that need them */ -}}
{{- if .Params.music -}}
<script src="/js/raphael.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/underscore-min.js"></script>
<script src="/js/vexflow-min.js"></script>
<script src="/js/tabdiv-min.js"></script>
<script src="/js/chord.js"></script>
<script src="/js/chart.js"></script>
<script src="/js/music-post.js"></script>
{{- end -}}
